<!DOCTYPE html><html lang="en" data-mode="dark" ><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Use Google Authenticator for 2FA with SSH" /><meta name="author" content="Steven Marks" /><meta property="og:locale" content="en" /><meta name="description" content="By default, SSH uses password authentication, most SSH hardening instructions recommend using SSH keys instead. However, SSH keys still only provide a single factor authentication, even though it is much more secure. But like someone can guess a password or get it from alternative sources, they can also steal your private SSH key and then access all data that key has access to." /><meta property="og:description" content="By default, SSH uses password authentication, most SSH hardening instructions recommend using SSH keys instead. However, SSH keys still only provide a single factor authentication, even though it is much more secure. But like someone can guess a password or get it from alternative sources, they can also steal your private SSH key and then access all data that key has access to." /><link rel="canonical" href="https://totaldebug.uk/posts/use-google-authenticator-ssh/" /><meta property="og:url" content="https://totaldebug.uk/posts/use-google-authenticator-ssh/" /><meta property="og:site_name" content="TotalDebug" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2014-01-08T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Use Google Authenticator for 2FA with SSH" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Steven Marks"},"dateModified":"2023-05-19T14:27:06+01:00","datePublished":"2014-01-08T00:00:00+00:00","description":"By default, SSH uses password authentication, most SSH hardening instructions recommend using SSH keys instead. However, SSH keys still only provide a single factor authentication, even though it is much more secure. But like someone can guess a password or get it from alternative sources, they can also steal your private SSH key and then access all data that key has access to.","headline":"Use Google Authenticator for 2FA with SSH","mainEntityOfPage":{"@type":"WebPage","@id":"https://totaldebug.uk/posts/use-google-authenticator-ssh/"},"url":"https://totaldebug.uk/posts/use-google-authenticator-ssh/"}</script><title>Use Google Authenticator for 2FA with SSH | TotalDebug</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="TotalDebug"><meta name="application-name" content="TotalDebug"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous" /><link rel="dns-prefetch" href="https://www.googletagmanager.com" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" /><link rel="stylesheet" href="/assets/css/style.css" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.1/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/logo.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">TotalDebug</a></div><div class="site-subtitle font-italic">Technology. Inside Out</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="bi bi-house ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="bi bi-list-nested ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="bi bi-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="bi bi-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="bi bi-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/works/" class="nav-link"> <i class="bi bi-kanban ml-xl-3 mr-xl-3 unloaded"></i> <span>WORKS</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/marksie1988" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="bi bi-github"></i> </a> <a href="https://www.linkedin.com/in/marksie1988" aria-label="linkedin" target="_blank" rel="noopener noreferrer"> <i class="bi bi-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="bi bi-rss"></i> </a> <a href="https://discord.gg/6fmekudc8Q" aria-label="discord" > <i class="bi bi-discord"></i> </a> <a href="https://github.com/marksie1988" aria-label="github" > <i class="bi bi-github"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Use Google Authenticator for 2FA with SSH</span> </span> <i id="sidebar-trigger" class="bi bi-list"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="bi bi-search"></i> <span id="search-wrapper" class="align-items-center"> <i class="bi bi-search"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Use Google Authenticator for 2FA with SSH</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1389139200" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 8, 2014 </em> </span> <span> Updated <em class="" data-ts="1684502826" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 19, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/marksie1988">Steven Marks</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1445 words"> <em>8 min</em> read</span></div></div></div><div class="d-none"><div id="posted-date">1389139200</div><div id="updated-date">1684502826</div></div><blockquote class="d-none prompt-info" id="post-age-notification"></blockquote><div class="post-content"><p>By default, SSH uses password authentication, most SSH hardening instructions recommend using SSH keys instead. However, SSH keys still only provide a single factor authentication, even though it is much more secure. But like someone can guess a password or get it from alternative sources, they can also steal your private SSH key and then access all data that key has access to.</p><p>In this guide, We will setup Two-Factor authentication (2FA) meaning that more than one factor is required to authenticate or log in. This means any hackers would need to compromise multiple devices, like your computer and your phone to get access.</p><h2 id="prerequisites"><span class="mr-2">Prerequisites</span><a href="#prerequisites" class="anchor text-muted"><i class="bi bi-hash"></i></a></h2><p>To follow this tutorial, you will need:</p><ul><li>One CentOS 8 or Ubuntu server with a sudo non-root user and SSH key<li>A phone or tablet with an OATH-TOTP app, like Authy or Google Authenticator</ul><h2 id="install-chrony-to-synchronize-the-system-clock"><span class="mr-2">Install chrony to synchronize the system clock</span><a href="#install-chrony-to-synchronize-the-system-clock" class="anchor text-muted"><i class="bi bi-hash"></i></a></h2><p>This step is very important, due to the way 2FA works, the time must be accurate on the server. Run the following commands to setup and install chrony:</p><div title="CentOS 8" class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="CentOS 8"><i class="bi bi-arrow-return-right"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>timedatectl set-timezone Europe/London
dnf <span class="nb">install </span>chrony <span class="nt">-y</span>
systemctl start chronyd
systemctl <span class="nb">enable </span>chronyd
</pre></table></code></div></div><div title="Ubuntu" class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Ubuntu"><i class="bi bi-arrow-return-right"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>timedatectl set-timezone Europe/London
<span class="nb">sudo </span>apt <span class="nb">install </span>chrony
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>chrony.service
<span class="nb">sudo </span>systemctl restart chrony.service
</pre></table></code></div></div><p>To change the nameservers, edit the configuration file:</p><ul><li>CentOS 8 - <code class="language-plaintext highlighter-rouge">/etc/chrony.conf</code><li>Ubuntu - <code class="language-plaintext highlighter-rouge">/etc/chrony/chrony.conf</code></ul><h2 id="install-the-google-pam"><span class="mr-2">Install the Google PAM</span><a href="#install-the-google-pam" class="anchor text-muted"><i class="bi bi-hash"></i></a></h2><p>In order to begin with configuring 2FA we will need to install the google authenticator PAM</p><h3 id="centos-8"><span class="mr-2">CentOS 8</span><a href="#centos-8" class="anchor text-muted"><i class="bi bi-hash"></i></a></h3><p>First, CentOS requires adding the EPEL repo:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>yum <span class="nb">install </span>epel-release
</pre></table></code></div></div><p>If you don’t have the package epel-release you can install this manually:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>yum <span class="nb">install </span>https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
</pre></table></code></div></div><p>Now, install the PAM:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>yum <span class="nb">install </span>google-authenticator qrencode-libs
</pre></table></code></div></div><h3 id="ubuntu"><span class="mr-2">Ubuntu</span><a href="#ubuntu" class="anchor text-muted"><i class="bi bi-hash"></i></a></h3><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>libpam-google-authenticator
</pre></table></code></div></div><h2 id="configure-ssh-to-use-2fa-with-google-authenticator-pam"><span class="mr-2">Configure SSH to use 2FA with Google Authenticator PAM</span><a href="#configure-ssh-to-use-2fa-with-google-authenticator-pam" class="anchor text-muted"><i class="bi bi-hash"></i></a></h2><blockquote class="prompt-warning"><p>Whilst making the following changes, it is important not to close the initial SSH connection. This could lock you out if anything goes wrong.</p></blockquote><p>To begin, back up the SSH configuration and then edit it</p><p>Backup the sshd configuration:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo cp</span> /etc/pam.d/sshd /etc/pam.d/sshd.bak
</pre></table></code></div></div><p>Update the configuration in <code class="language-plaintext highlighter-rouge">/etc/pam.d/sshd</code>:</p><div title="CentOS 8" class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="CentOS 8"><i class="bi bi-arrow-return-right"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>auth  required  pam_google_authenticator.so <span class="nv">secret</span><span class="o">=</span>/home/<span class="k">${</span><span class="nv">USER</span><span class="k">}</span>/.ssh/google_authenticator nullok
auth  required  pam_permit.so
</pre></table></code></div></div><p>The configuration for CentOS is slightly different as it uses SELINUX which doesn’t allow the SSH Daemon to write files outside of the <code class="language-plaintext highlighter-rouge">.ssh</code> directory in your home folder.</p><p>Due to this, we need to specify where the configuration file location is with hte <code class="language-plaintext highlighter-rouge">secret</code> option.</p><div title="Ubuntu" class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Ubuntu"><i class="bi bi-arrow-return-right"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>auth  required pam_google_authenticator.so
auth  required pam_permit.so
</pre></table></code></div></div><blockquote class="prompt-info"><p><code class="language-plaintext highlighter-rouge">nullok</code> at the end of the line tells the PAM that this authentication method is optional. This allows users without a OATH-TOTP token to still log in just using their SSH key. Once all users have an OATH-TOTP token, you can remove <code class="language-plaintext highlighter-rouge">nullok</code> from this line to make MFA mandatory.</p></blockquote><p>you can now save and close the file.</p><p>We now need to configure SSH to support this authentication method:</p><p>First backup the SSH configuration:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo cp</span> /etc/ssh/sshd_config /etc/ssh/sshd_config.bak
</pre></table></code></div></div><p>Now look for the line <code class="language-plaintext highlighter-rouge">ChallengeResponseAuthentication</code>. change this to <code class="language-plaintext highlighter-rouge">yes</code></p><div file="/etc/ssh/sshd_config" class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="/etc/ssh/sshd_config"><i class="bi bi-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c"># Change to no to disable s/key passwords</span>
ChallengeResponseAuthentication <span class="nb">yes</span>
</pre></table></code></div></div><p>Save and close this file, then restart SSH to reload the configuration. This wont close your current open connections so you wont lose access.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl restart sshd
</pre></table></code></div></div><h3 id="create-your-token"><span class="mr-2">Create your token</span><a href="#create-your-token" class="anchor text-muted"><i class="bi bi-hash"></i></a></h3><p>We now need to create our 2FA token, to do this we run the following command:</p><div title="CentOS 8" class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="CentOS 8"><i class="bi bi-arrow-return-right"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>google-authenticator <span class="nt">-s</span> ~/.ssh/google_authenticator
</pre></table></code></div></div><div title="Ubuntu" class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Ubuntu"><i class="bi bi-arrow-return-right"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>google-authenticator
</pre></table></code></div></div><p>After you run this command you will be asked a few questions. The first question asks if authentication should be time based:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Do you want authentication tokens to be time-based <span class="o">(</span>y/n<span class="o">)</span> y
</pre></table></code></div></div><p>This PAM allows time-based or sequential-based tokens, Using sequential based means the token increases by 1 after each use. Using time-based means that the token is based on a certain point in time.</p><p>After answering this question a large QR Code will appear, using your phone authenticator app, take a picture of the QR Code to add it to your application. A URL is also provided above the QR Code to open in a browser if required.</p><p>The remaining options inform PAM how to function, I have listed these below with the options that I chose, you can change these as you see fit for your requirements.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Do you want me to update your <span class="s2">"~/.google_authenticator"</span> file <span class="o">(</span>y/n<span class="o">)</span> y
</pre></table></code></div></div><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>Do you want to disallow multiple uses of the same authentication
token? This restricts you to one login about every 30s, but it increases
your chances to notice or even prevent man-in-the-middle attacks <span class="o">(</span>y/n<span class="o">)</span> y
</pre></table></code></div></div><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>By default, a new token is generated every 30 seconds by the mobile app.
In order to compensate <span class="k">for </span>possible time-skew between the client and the server,
we allow an extra token before and after the current time. This allows <span class="k">for </span>a
<span class="nb">time </span>skew of up to 30 seconds between authentication server and client. If you
experience problems with poor <span class="nb">time </span>synchronization, you can increase the window
from its default size of 3 permitted codes <span class="o">(</span>one previous code, the current
code, the next code<span class="o">)</span> to 17 permitted codes <span class="o">(</span>the 8 previous codes, the current
code, and the 8 next codes<span class="o">)</span><span class="nb">.</span> This will permit <span class="k">for </span>a <span class="nb">time </span>skew of up to 4 minutes
between client and server.
Do you want to <span class="k">do </span>so? <span class="o">(</span>y/n<span class="o">)</span> n
</pre></table></code></div></div><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>If the computer that you are logging into isn<span class="s1">'t hardened against brute-force
login attempts, you can enable rate-limiting for the authentication module.
By default, this limits attackers to no more than 3 login attempts every 30s.
Do you want to enable rate-limiting (y/n) y
</span></pre></table></code></div></div><p>Once finished you can backup your secret key by copying the <code class="language-plaintext highlighter-rouge">~/.ssh/google-authenticator</code> file to a trusted location. You can also copy this to other servers to use on multiple machines, however it is worth keeping in mind that then if one server is attacked there is potential for an attacker to gain access to other servers.</p><h2 id="make-ssh-aware-of-2fa"><span class="mr-2">Make SSH Aware of 2FA</span><a href="#make-ssh-aware-of-2fa" class="anchor text-muted"><i class="bi bi-hash"></i></a></h2><p>Re-open the sshd configuration file and add the following line to the bottom of the file. This tells SSH whcih authentication methods are required:</p><div file="/etc/ssh/sshd_config" class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="/etc/ssh/sshd_config"><i class="bi bi-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>AuthenticationMethods publickey,password publickey,keyboard-interactive
</pre></table></code></div></div><p>Save and close the file.</p><p>Next, open the PAM sshd configuration file again and find the line <code class="language-plaintext highlighter-rouge">auth substack password-auth</code>. comment it out by adding a <code class="language-plaintext highlighter-rouge">#</code> to the start of the line:</p><div file="/etc/pam.d/sshd" class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="/etc/pam.d/sshd"><i class="bi bi-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="c"># auth  substack  password-auth</span>
</pre></table></code></div></div><blockquote class="prompt-tip"><p>If you want three factors of authentication, you can skip commenting this line</p></blockquote><p>Save and close the file, then restart SSH:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl restart sshd
</pre></table></code></div></div><p>Now login to the server with a different terminal session/window. Unlike last time, SSH should ask for your verification code. Upon entering it, you’ll be logged in. Even though you don’t see any indication that your SSH key was used, your login attempt used two factors. If you want to verify, you can add -v (for verbose).</p><h2 id="avoid-2fa-in-certain-situations-optional"><span class="mr-2">Avoid 2FA in certain situations (optional)</span><a href="#avoid-2fa-in-certain-situations-optional" class="anchor text-muted"><i class="bi bi-hash"></i></a></h2><h3 id="user-accounts"><span class="mr-2">User Accounts</span><a href="#user-accounts" class="anchor text-muted"><i class="bi bi-hash"></i></a></h3><p>There may be some situations where a specific user or service account needs SSH access without 2FA enabled. For example, if an application doesn’t have a way to request the verification code, the request may get stuck until the SSH connection times out.</p><p>To allow MFA for some accounts and SSH key only for others, make sure the configuration in <code class="language-plaintext highlighter-rouge">/etc/pam.d/sshd</code> contains the <code class="language-plaintext highlighter-rouge">nullok</code> option as shown in previous steps.</p><p>After setting this, simply run the <code class="language-plaintext highlighter-rouge">google-authenticatior</code> command for any users that require 2FA.</p><p>Alternatively, if you only want to allow a single user to bypass 2FA you can add the following:</p><div file="/etc/pam.d/sshd" class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="/etc/pam.d/sshd"><i class="bi bi-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>auth <span class="o">[</span><span class="nv">success</span><span class="o">=</span><span class="k">done </span><span class="nv">new_authtok_reqd</span><span class="o">=</span><span class="k">done </span><span class="nv">default</span><span class="o">=</span>die] pam_google_authenticator.so
auth <span class="o">[</span><span class="nv">success</span><span class="o">=</span><span class="k">done </span><span class="nv">new_authtok_reqd</span><span class="o">=</span><span class="k">done </span><span class="nv">default</span><span class="o">=</span>die] pam_succeed_if.so user <span class="o">=</span> john
</pre></table></code></div></div><h3 id="specific-networks"><span class="mr-2">Specific Networks</span><a href="#specific-networks" class="anchor text-muted"><i class="bi bi-hash"></i></a></h3><p>There may be some situations where specific networks are trusted and dont require 2FA to be used, in these situations we can update the configuration with the following:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>auth <span class="o">[</span><span class="nv">success</span><span class="o">=</span>1 <span class="nv">default</span><span class="o">=</span>ignore] pam_access.so <span class="nv">accessfile</span><span class="o">=</span>/etc/security/access-local.conf
auth required pam_google_authenticator.so nullok
</pre></table></code></div></div><p>Create the device authentication configuration file for the specified ip addresses:</p><div file="/etc/security/access-local.conf" class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="/etc/security/access-local.conf"><i class="bi bi-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># Two-factor can be skipped on local network</span>
+ : ALL : 10.0.0.0/24
+ : ALL : LOCAL
- : ALL : ALL
</pre></table></code></div></div><p>Local login attempts from 10.0.0.0/24 will not require two-factor authentication, while all others do. Now we need to edit the ssh daemon configuration file.</p><blockquote class="prompt-warning"><p>Please keep in mind that this could add a security risk if not locked down sufficiently</p></blockquote><p>Restart the SSH daemon:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="bi bi-code-slash small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="bi bi-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>systemctl restart sshd
</pre></table></code></div></div><h2 id="final-thoughts"><span class="mr-2">Final Thoughts</span><a href="#final-thoughts" class="anchor text-muted"><i class="bi bi-hash"></i></a></h2><p>This how-to guide has taken you through how to add 2FA authentication using google authentication via your computer and your phone making your system considerably more secure. It is now much more difficult for a brute force attack via SSH.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="bi bi-folder2-open mr-1"></i> <a href="/categories/linux/" >Linux</a >, <a href="/categories/authentication/" >Authentication</a ></div><div class="post-tags"> <i class="bi bi-tags mr-1"></i> <a href="/tags/hot-to/" class="post-tag no-text-decoration" >hot-to</a> <a href="/tags/2fa/" class="post-tag no-text-decoration" >2fa</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/auth/" class="post-tag no-text-decoration" >auth</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2" ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Use%20Google%20Authenticator%20for%202FA%20with%20SSH%20-%20TotalDebug&url=https%3A%2F%2Ftotaldebug.uk%2Fposts%2Fuse-google-authenticator-ssh%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw bi bi-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Use%20Google%20Authenticator%20for%202FA%20with%20SSH%20-%20TotalDebug&u=https%3A%2F%2Ftotaldebug.uk%2Fposts%2Fuse-google-authenticator-ssh%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw bi bi-facebook"></i> </a> <a href="https://telegram.me/share?text=Use%20Google%20Authenticator%20for%202FA%20with%20SSH%20-%20TotalDebug&url=https%3A%2F%2Ftotaldebug.uk%2Fposts%2Fuse-google-authenticator-ssh%2F" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw bi bi-telegram"></i> </a> <a href="https://news.ycombinator.com/submitlink?t=Use%20Google%20Authenticator%20for%202FA%20with%20SSH%20-%20TotalDebug&u=https%3A%2F%2Ftotaldebug.uk%2Fposts%2Fuse-google-authenticator-ssh%2F" data-toggle="tooltip" data-placement="top" title="HackerNews" target="_blank" rel="noopener" aria-label="HackerNews"> <i class="fa-fw bi bi-hacker-news"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ftotaldebug.uk%2Fposts%2Fuse-google-authenticator-ssh%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw bi bi-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/last4solar-my-solar-nightmare/">Last4Solar - My solar nightmare!</a><li><a href="/posts/jekyll-post-series-links/">Add series links to Jekyll posts</a><li><a href="/posts/proxmox-template-with-cloud-image-and-cloud-init/">Proxmox Template with Cloud Image and Cloud Init</a><li><a href="/posts/automating-proxmox-with-terraform-ansible/">Automating deployments using Terraform with Proxmox and ansible</a><li><a href="/posts/use-google-authenticator-ssh/">Use Google Authenticator for 2FA with SSH</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/centos/">centos</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/unifi/">unifi</a> <a class="post-tag" href="/tags/best-practices/">best practices</a> <a class="post-tag" href="/tags/code-quality/">code quality</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/configuration/">configuration</a> <a class="post-tag" href="/tags/container/">container</a> <a class="post-tag" href="/tags/exchange/">exchange</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/proxmox-template-with-cloud-image-and-cloud-init/"><div class="card-body"> <em class="small" data-ts="1664909640" data-df="ll" > Oct 4, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Proxmox Template with Cloud Image and Cloud Init</h3><div class="text-muted small"><p> Updated to latest Ubuntu image &amp;amp; Added enable for qemu service Using Cloud images and Cloud init with Proxmox is the quickest, most efficient way to deploy servers at this time. Cloud imag...</p></div></div></a></div><div class="card"> <a href="/posts/mikrotik-openvpn-server-with-linux-client/"><div class="card-body"> <em class="small" data-ts="1438124400" data-df="ll" > Jul 29, 2015 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Mikrotik OpenVPN Server with Linux Client</h3><div class="text-muted small"><p> I spent quite some time trying to get the OpenVPN Server working on the Mikrotik Router with a Linux client, It caused some pain and I didn’t want others to go through that. I have therefore writte...</p></div></div></a></div><div class="card"> <a href="/posts/two-factor-authentication-worth-really-add-security/"><div class="card-body"> <em class="small" data-ts="1482174000" data-df="ll" > Dec 19, 2016 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Two-Factor Authentication: is it worth it, does it really add more security?</h3><div class="text-muted small"><p> As we all move to a digital age, adding more and more personal information to the internet security has become a real issue, in recent years there have been hack attempts on well-known brands, incl...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/php-notice-undefined-index/" class="btn btn-outline-primary" prompt="Older"><p>PHP Notice: Undefined index</p></a> <a href="/posts/view-virtual-machines-snapshots-vmware/" class="btn btn-outline-primary" prompt="Newer"><p>How to view which Virtual Machines have Snapshots in VMware</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "totaldebug/totaldebug.uk", "data-repo-id": "MDEwOlJlcG9zaXRvcnkzMTkxMTkxNTE=", "data-category": "General", "data-category-id": "DIC_kwDOEwVfL84CPpH4", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/centos/">centos</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/unifi/">unifi</a> <a class="post-tag" href="/tags/best-practices/">best practices</a> <a class="post-tag" href="/tags/code-quality/">code quality</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/configuration/">configuration</a> <a class="post-tag" href="/tags/container/">container</a> <a class="post-tag" href="/tags/exchange/">exchange</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/marksie1988">Steven Marks</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a></p></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button" > <i class="bi bi-chevron-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false" ><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close" > <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3"> A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="card post-preview"> <a style="text-decoration: none;" href="{url}"><div class="card-body"><h1 class="card-title"> {title}</h1><div class="card-text post-content"> {snippet}</div><div class="post-meta text-muted d-flex"><div class="mr-auto"> {categories} {tags}</div></div></div></a></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<i class="bi bi-folder"></i>${value}`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<i class="bi bi-tag"></i>${value}`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1.11.6/dayjs.min.js,npm/dayjs@1.11.6/locale/en.min.js,npm/dayjs@1.11.6/plugin/relativeTime.min.js,npm/dayjs@1.11.6/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-ZDGYQV98HT"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-ZDGYQV98HT'); }); </script>
